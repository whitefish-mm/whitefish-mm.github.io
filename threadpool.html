<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Begin Jekyll SEO tag v2.7.1 -->
    <title>TechSalam</title>
    <meta name="generator" content="Jekyll v3.9.0" />
    <meta property="og:title" content="Markup: Syntax Highlighting" />
    <meta name="author" content="Michael Rose" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content="Post displaying the various ways one can highlight code blocks with Jekyll. Some options include standard Markdown, GitHub Flavored Markdown, and Jekyll’s {% highlight %} tag."
    />
    <meta
      property="og:description"
      content="Post displaying the various ways one can highlight code blocks with Jekyll. Some options include standard Markdown, GitHub Flavored Markdown, and Jekyll’s {% highlight %} tag."
    />
    <link
      rel="canonical"
      href="https://mmistakes.github.io/so-simple-theme/markup-syntax-highlighting/"
    />
    <meta
      property="og:url"
      content="https://mmistakes.github.io/so-simple-theme/markup-syntax-highlighting/"
    />
    <meta property="og:site_name" content="So Simple" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2013-08-16T00:00:00+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Markup: Syntax Highlighting" />
    <meta name="twitter:site" content="@mmistakes" />
    <meta name="twitter:creator" content="@mmistakes" />
    <meta
      name="google-site-verification"
      content="UQj93ERU9zgECodaaXgVpkjrFn9UrDMEzVamacSoQ8Y"
    />
    <script type="application/ld+json">
      {
        "description": "Post displaying the various ways one can highlight code blocks with Jekyll. Some options include standard Markdown, GitHub Flavored Markdown, and Jekyll’s {% highlight %} tag.",
        "url": "https://mmistakes.github.io/so-simple-theme/markup-syntax-highlighting/",
        "@type": "BlogPosting",
        "headline": "Markup: Syntax Highlighting",
        "dateModified": "2017-03-09T15:27:01+00:00",
        "datePublished": "2013-08-16T00:00:00+00:00",
        "publisher": {
          "@type": "Organization",
          "logo": {
            "@type": "ImageObject",
            "url": "https://mmistakes.github.io/so-simple-theme/images/so-simple-site-logo.png"
          },
          "name": "Michael Rose"
        },
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://mmistakes.github.io/so-simple-theme/markup-syntax-highlighting/"
        },
        "author": { "@type": "Person", "name": "Michael Rose" },
        "@context": "https://schema.org"
      }
    </script>
    <!-- End Jekyll SEO tag -->

    <script>
      /* Cut the mustard */
      if ('querySelector' in document && 'addEventListener' in window) {
        document.documentElement.className =
          document.documentElement.className.replace(/\bno-js\b/g, '') + 'js'
      }
    </script>

    <link rel="stylesheet" href="./assets/css/main.css" />
    <link rel="stylesheet" href="./assets/css/default.css" />
    <link rel="stylesheet"
    href="./prism.css">
<script src="./prism.js"></script>   <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i|Lora:400,400i,700,700i"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      title="So Simple"
      href="/so-simple-theme/atom.xml"
    />
    <style>
      p{
        text-align: justify;
      }
    </style>
    <!-- start custom head snippets -->

    <!-- insert favicons. use http://realfavicongenerator.net/ -->

    <!-- end custom head snippets -->
  </head>

  <body class="layout--post markup-syntax-highlighting">
    <nav class="skip-links">
      <h2 class="screen-reader-text">Skip links</h2>
      <ul>
        <li>
          <a href="#primary-nav" class="screen-reader-shortcut">
            Skip to primary navigation
          </a>
        </li>
        <li>
          <a href="#main" class="screen-reader-shortcut">Skip to content</a>
        </li>
        <li>
          <a href="#footer" class="screen-reader-shortcut">Skip to footer</a>
        </li>
      </ul>
    </nav>

    <div class="navigation-wrapper">
      <a href="#menu-toggle" id="menu-toggle">Menu</a>
      <nav id="primary-nav" class="site-nav animated drop">
        <ul>
          <li><a href="./index.html">Home</a></li>
          <li><a href="./about.html">About</a></li>
          <li><a href="https://github.com/whitefish-mm">GitHub</a></li>
        </ul>
      </nav>
    </div>
    <!-- /.navigation-wrapper -->

    <header class="masthead">
      <div class="wrap">
        <a
          href="./index.html"
          class="site-logo"
          rel="home"
          title="So Simple"
        >
          <img
            src="./img/a.jpg"
            class="site-logo-img animated fadeInDown"
            alt="So Simple"
          />
        </a>

        <h1 class="site-title animated fadeIn">
          <a href="./index.html">TechSalam</a>
        </h1>

        <p class="site-description animated fadeIn" style="text-align: center;" itemprop="description">
          Exploring the Cutting Edge of Technology with Abdelsalam Elomda
        </p>
      </div>
    </header>
    <!-- /.masthead -->

    <main id="main" class="main-content" aria-label="Content">
      <article class="h-entry">
        <div class="page-wrapper">
          <header class="page-header">
            <h1 id="page-title" class="page-title p-name">
              Implementing Threadpools in C
            </h1>
          </header>

          <div class="page-sidebar">
            <div class="page-author h-card p-author">
              <img
                src="./img/a.jpg"
                class="author-avatar u-photo"
                alt="Michael Rose"
              />
              <div class="author-info">
                <div class="author-name">
                  <em>by</em>
                  <span class="p-name">Abdelsalam Elomda</span>
                </div>
                <ul class="author-links">
                  <li class="author-link">
                    <a
                      class="u-url"
                      rel="me"
                      href="https://github.com/whitefish-mm"
                    >
                      <i class="fab fa-github-square fa-lg" title="GitHub"></i>
                    </a>
                  </li>
                </ul>

                <time
                  class="page-date dt-published"
                  datetime="2013-08-16T00:00:00+00:00"
                >
                  <a class="u-url" href="">August 16, 2019</a>
                </time>
              </div>
            </div>
          </div>

          <div class="page-content">
            <div class="e-content">

              <p>
                Today, we're going to build a threadpool in C. I remember when I first implemented a threadpool for a project at my first job, it was quite an adventure, threading can be a bit tricky, but I assure you, it's worth the journey. So, let's dive in!
              </p>

              <h4>What's a Threadpool?</h4>

              <p>In concurrent programming, a threadpool is a collection of worker threads that efficiently execute asynchronous tasks. Threadpools are crucial for tasks that involve blocking operations such as I/O, as they help to avoid blocking the main thread and causing the application to become unresponsive.</p>

              <h4>Where are Threadpools Used?</h4>

              <p>
                Threadpools are widely used in scenarios where you have to deal with many short-lived tasks, especially when their execution is I/O bound or involves waiting, like in web servers, GUI applications, or background tasks processors.
              </p>

              <h4>Building a Threadpool in C: The Step-by-Step Guide</h4>

              <p>Here's a simplified program that illustrates how to create and use a threadpool. We will build it incrementally, explaining each step along the way. We'll be using the POSIX threads library (<b>pthread.h</b>).</p>
              
              <h4>1. The Task Structure</h4>
              <p>
                To kick things off, let's talk about a fundamental concept that we'll use throughout this tutorial, and that's the notion of maintaining a <b>'state'</b> while we're processing data. In our context, this 'state' is going to be represented by a struct in C. Let's call it State.
              </p>

<pre><code class="language-c">typedef struct
{
    // Add any data which your multithreading program will hold
} State;</code></pre>
<br/>

              <p>Then we proceed to defining a structure to hold the data needed for our tasks. Let's call it <b>JobData</b>.</p>

              <pre><code class="language-c">typedef struct
{
    const unsigned char *content;
    size_t length;
    State *state;
    pthread_mutex_t *mutex;
} JobData; </code></pre>
<br/>
              <p>This structure holds the data that we'll process (<b>content</b> and <b>length</b>), a state that will be shared among tasks (<b>state</b>), and a mutex for thread-safe printing to the standard output (<b>mutex</b>).

              </p>

              <h4>2. The Worker Function</h4>

              <p>Next, we define the function that the worker threads will execute. This function will take a <b>JobData</b> structure as its argument, process the data, and update the shared state.</p>

<pre><code class="language-c">void execute_job(const unsigned char *content, size_t length, State *state, pthread_mutex_t *mutex)
  {
      pthread_mutex_lock(mutex);
      // Execute the job using the state here
      pthread_mutex_unlock(mutex);
  }
  
  void *load_job_in_pool(void *arg)
  {
      JobData *job_data = (JobData *)arg;
      execute_job(job_data->content, job_data->length, job_data->state, job_data->mutex);
      return NULL;
  }
  </code></pre>
  <br/>
            <p>In this function, we lock the mutex before executing the job to ensure that only one thread can update the state and print to the standard output at a time.            </p>
           

          <h4>3. Creating the Threadpool</h4>

          <p>We're now ready to create the threadpool. In the <b> main</b> function, we start by parsing command-line options and initializing our shared state and mutex.</p>


<pre><code class="language-c">int main(int argc, char *argv[])
  {
      // Parse command-line options
      // ...
  
      // Initialize shared state and mutex
      State state = NULL; //Initialize the state here to your needs
      pthread_t *workers = malloc(num_workers * sizeof(pthread_t));
      pthread_mutex_t print_mutex;
      pthread_mutex_init(&print_mutex, NULL);
      // ...
  }</code></pre>
  <br/>
<h4>4. Dispatching Jobs to the Threadpool</h4>
<p>Next, we open each input file, map it into memory, divide it into chunks, and dispatch these chunks to our threadpool. You probably want to define a chunk size specifically ahead such that</p>

<pre><code class="language-c">#define CHUNK_SIZE 1024</code></pre>

Then begin our code to dispatch jobs to the threadpool.

<pre><code class="language-c">for (int i = optind; i < argc; i++)
  {
      // Open the file and map it into memory
      // ...
  
      size_t num_sections = (file_size + CHUNK_SIZE - 1) / CHUNK_SIZE;
  
      // If it's the first file, initialize the state
      if (first_file)
      {
          //Initialize your state here
          first_file = false;
      }
  
      for (size_t section = 0; section < num_sections; section++)
      {
          size_t remaining_workers = num_workers;
          size_t remaining_sections = num_sections - section;
          size_t workers_to_use;
  
          if (remaining_workers < remaining_sections)
          {
              workers_to_use = remaining_workers;
          }
          else
          {
              workers_to_use = remaining_sections;
          }
  
          JobData *jobs = malloc(workers_to_use * sizeof(JobData));
  
          for (size_t j = 0; j < workers_to_use; j++)
          {
              jobs[j].content = mapped_file + (section + j) * CHUNK_SIZE;
  
              if ((section + j + 1) * CHUNK_SIZE <= (size_t)file_size)
              {
                  jobs[j].length = CHUNK_SIZE;
              }
              else
              {
                  jobs[j].length = file_size % CHUNK_SIZE;
              }
  
              jobs[j].state = &state;
              jobs[j].mutex = &print_mutex;
  
              pthread_create(&workers[j], NULL, load_job_in_pool, &jobs[j]);
          }
  
          for (size_t j = 0; j < workers_to_use; j++)
          {
              pthread_join(workers[j], NULL);
          }
  
          free(jobs);
          section += workers_to_use - 1;
      }
  
      // Unmap the file and close it
      // ...
  
  }</code></pre>
  <br/>
  <p>Here, we first calculate the number of chunks or sections that the file will be divided into. We then iterate over each section, allocating jobs for as many workers as we can use, creating the worker threads and waiting for them to finish before moving on to the next set of sections. 
  </p>

<h4>5. Cleaning Up</h4>
<p>Finally, we print the final state, free the memory allocated for the worker threads, and destroy the mutex.
</p>

<pre><code class="language-c">pthread_mutex_lock(&print_mutex);
fwrite(&(state), 1, 1, stdout);
pthread_mutex_unlock(&print_mutex);

free(workers);
pthread_mutex_destroy(&print_mutex);

return 0; </code></pre>
<br/>
<h3>Real-World Applications of Threadpools</h3>

<p>Threadpools are used in a wide range of applications. For instance, web servers use threadpools to handle multiple concurrent client connections. Database servers use them to process multiple simultaneous queries. In the scientific computing realm, they're used to parallelize computations and make better use of multicore CPUs.</p>

<p>In this tutorial, we've implemented a simple threadpool for processing file data in parallel. However, the same principles can be applied to create more complex threadpool-based applications.</p>

<p>That's it for this tutorial! I hope this helps you understand threadpools better and enables you to utilize them in your own projects. As always, happy coding!</p>

            </div>
          </div>
        </div>
      </article>
    </main>

    <footer id="footer" class="site-footer">
      <script
        async
        src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
      ></script>
      <div align="center" style="margin: 1em 0;">
        <ins
          class="adsbygoogle"
          style="display: block; border-bottom: initial;"
          data-ad-client="ca-pub-7328585512091257"
          data-ad-slot="3049671934"
          data-ad-format="auto"
        ></ins>
      </div>
      <script>
        ;(adsbygoogle = window.adsbygoogle || []).push({})
      </script>
      <div class="social-icons">
        <a class="social-icon" href="https://github.com/whitefish-mm">
          <i class="fab fa-github-square fa-2x" title="GitHub"></i>
        </a>
      </div>
      <div class="copyright">
        <p style="text-align: center;">
          &copy; 2023 Abdelsalam Elomda. Follow me on
          <a href="https://github.com/whitefish-mm">my GitHub</a>
        </p>
      </div>
    </footer>

    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script src="./assets/js/main.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>
    <script>
      if (
        !(
          window.doNotTrack === '1' ||
          navigator.doNotTrack === '1' ||
          navigator.doNotTrack === 'yes' ||
          navigator.msDoNotTrack === '1'
        )
      ) {
        ;(function (i, s, o, g, r, a, m) {
          i['GoogleAnalyticsObject'] = r
          ;(i[r] =
            i[r] ||
            function () {
              ;(i[r].q = i[r].q || []).push(arguments)
            }),
            (i[r].l = 1 * new Date())
          ;(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0])
          a.async = 1
          a.src = g
          m.parentNode.insertBefore(a, m)
        })(
          window,
          document,
          'script',
          'https://www.google-analytics.com/analytics.js',
          'ga',
        )
        ga('create', 'UA-2011187-2', 'auto')
        ga('send', 'pageview')
      }
    </script>

    <!-- MathJax -->

    <script>
      // http://docs.mathjax.org/en/latest/upgrading/v2.html
      MathJax = {
        tex: {
          tags: 'ams', // eq numbering options: none, ams, all
        },
        options: {
          renderActions: {
            // for mathjax 3, handle <script "math/tex"> blocks inserted by kramdown
            find: [
              10,
              function (doc) {
                for (const node of document.querySelectorAll(
                  'script[type^="math/tex"]',
                )) {
                  const display = !!node.type.match(/; *mode=display/)
                  const math = new doc.options.MathItem(
                    node.textContent,
                    doc.inputJax[0],
                    display,
                  )
                  const text = document.createTextNode('')
                  node.parentNode.replaceChild(text, node)
                  math.start = { node: text, delim: '', n: 0 }
                  math.end = { node: text, delim: '', n: 0 }
                  doc.math.push(math)
                }
              },
              '',
            ],
          },
        },
      }
    </script>

    <script
      type="text/javascript"
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"
    ></script>
  </body>
</html>
